# Terraform AWS EKS Autoscaler Module

## This Module Has Moved To:

<https://registry.terraform.io/modules/etesiai/eks-autoscaler/aws/latest>

Deploys configures IAM roles that allow a kubernetes cluster autoscaler helm release to correctly autoscale a EKS cluster. Added support for Nvidia Daemonset Plugin. All ASG created will use latest AMIs based on cluster version. GPU enabled AMIs are auto detected when gpu enabled instance types are chosen.

- [Registry](https://registry.terraform.io/modules/OmniTeqSource/eks-autoscaler/aws/latest)

### Charts

- [cluster-autoscaler](https://kubernetes.github.io/autoscaler)
- [nvidia-plugin](https://nvidia.github.io/k8s-device-plugin)

## terraform-docs usage

`sed -i '/^<!--- start terraform-docs --->/q' README.md && terraform-docs md . >> README.md`

<!--- start terraform-docs --->

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 0.15  |
| <a name="requirement_helm"></a> [helm](#requirement_helm)                | >= 2.0.0 |

## Providers

| Name                                                | Version  |
| --------------------------------------------------- | -------- |
| <a name="provider_aws"></a> [aws](#provider_aws)    | n/a      |
| <a name="provider_helm"></a> [helm](#provider_helm) | >= 2.0.0 |

## Modules

| Name                                            | Source                                | Version |
| ----------------------------------------------- | ------------------------------------- | ------- |
| <a name="module_this"></a> [this](#module_this) | terraform-aws-modules/autoscaling/aws | 4.4.0   |

## Resources

| Name                                                                                                                                          | Type        |
| --------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [aws_iam_instance_profile.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_instance_profile)             | resource    |
| [aws_iam_policy.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_policy)                                 | resource    |
| [aws_iam_role.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)                                     | resource    |
| [aws_iam_role_policy_attachment.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment) | resource    |
| [helm_release.cluster-autoscaler](https://registry.terraform.io/providers/hashicorp/helm/latest/docs/resources/release)                       | resource    |
| [helm_release.nvidia-plugin](https://registry.terraform.io/providers/hashicorp/helm/latest/docs/resources/release)                            | resource    |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity)                 | data source |
| [aws_iam_policy_document.this_autoscaler](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document) | data source |
| [aws_iam_policy_document.this_oidc](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document)       | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region)                                   | data source |
| [aws_ssm_parameter.this](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ssm_parameter)                        | data source |
| [aws_ssm_parameter.this_gpu](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/ssm_parameter)                    | data source |

## Inputs

| Name                                                                                                   | Description                                                                                                                         | Type                                                                                                                                                                                                                                                                                                                                                                                                                                  | Default                                                                          | Required |
| ------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | :------: |
| <a name="input_args"></a> [args](#input_args)                                                          | Extra args for cluster autoscaler                                                                                                   | `map(any)`                                                                                                                                                                                                                                                                                                                                                                                                                            | `{}`                                                                             |    no    |
| <a name="input_autoscaler_namespace"></a> [autoscaler_namespace](#input_autoscaler_namespace)          | Namespace of cluster autoscaler helm release                                                                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | `"kube-system"`                                                                  |    no    |
| <a name="input_autoscaler_nodeselector"></a> [autoscaler_nodeselector](#input_autoscaler_nodeselector) | Node selector on cluster autoscaler helm release                                                                                    | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                         | `{}`                                                                             |    no    |
| <a name="input_autoscaler_tolerations"></a> [autoscaler_tolerations](#input_autoscaler_tolerations)    | Tolerations on cluster autoscaler helm release                                                                                      | <pre>list(object({<br> key = string<br> value = string<br> effect = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                              | `[]`                                                                             |    no    |
| <a name="input_ca_image_tag"></a> [ca_image_tag](#input_ca_image_tag)                                  | Cluster-autoscaler helm image tag. This is versioned differently than the image. Make sure to align this tag with your k8s version. | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | `"v1.21.1"`                                                                      |    no    |
| <a name="input_ca_version"></a> [ca_version](#input_ca_version)                                        | Cluster-autoscaler helm release version                                                                                             | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | `"9.10.4"`                                                                       |    no    |
| <a name="input_cluster_id"></a> [cluster_id](#input_cluster_id)                                        | EKS cluster id                                                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a                                                                              |   yes    |
| <a name="input_cluster_oidc_issuer_url"></a> [cluster_oidc_issuer_url](#input_cluster_oidc_issuer_url) | The url generated when OIDC is configured with EKS.                                                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a                                                                              |   yes    |
| <a name="input_cluster_version"></a> [cluster_version](#input_cluster_version)                         | Kubernetes version                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a                                                                              |   yes    |
| <a name="input_deploy_autoscaler"></a> [deploy_autoscaler](#input_deploy_autoscaler)                   | Deploys cluster-autoscaler as a helm-release                                                                                        | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                | `true`                                                                           |    no    |
| <a name="input_deploy_nvidia_plugin"></a> [deploy_nvidia_plugin](#input_deploy_nvidia_plugin)          | Flag to deploy nvidia daemonset                                                                                                     | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                | `false`                                                                          |    no    |
| <a name="input_gpu_node_labels"></a> [gpu_node_labels](#input_gpu_node_labels)                         | Node labels for Nvidia Daemon helm chart.                                                                                           | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                         | `{}`                                                                             |    no    |
| <a name="input_groups"></a> [groups](#input_groups)                                                    | Overrides to global ASG per group. Will detect GPU instance from built in list.                                                     | <pre>list(object({<br> name = string<br> subnets = optional(list(string))<br> node_labels = optional(map(string))<br> instance_type = optional(string)<br> min_size = optional(number)<br> max_size = optional(number)<br><br> taints = optional(map(object({<br> value = string<br> effect = string<br> })))<br><br> tags = optional(map(object({<br> value = string<br> propagate_at_launch = optional(bool)<br> })))<br> }))</pre> | `[]`                                                                             |    no    |
| <a name="input_instance_type"></a> [instance_type](#input_instance_type)                               | Instance type for ASG                                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | `"t2.small"`                                                                     |    no    |
| <a name="input_max_size"></a> [max_size](#input_max_size)                                              | Max ASG size                                                                                                                        | `number`                                                                                                                                                                                                                                                                                                                                                                                                                              | `1`                                                                              |    no    |
| <a name="input_min_size"></a> [min_size](#input_min_size)                                              | Min ASG size                                                                                                                        | `number`                                                                                                                                                                                                                                                                                                                                                                                                                              | `0`                                                                              |    no    |
| <a name="input_name"></a> [name](#input_name)                                                          | Unique name, used in ASG resources                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | n/a                                                                              |   yes    |
| <a name="input_node_labels"></a> [node_labels](#input_node_labels)                                     | Global node labels for ASG                                                                                                          | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                         | `{}`                                                                             |    no    |
| <a name="input_nvidia_version"></a> [nvidia_version](#input_nvidia_version)                            | Chart version of nvidia plugin helm release                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | `"0.9.0"`                                                                        |    no    |
| <a name="input_root_block_device"></a> [root_block_device](#input_root_block_device)                   | Pass through to ASG module                                                                                                          | `list(map(string))`                                                                                                                                                                                                                                                                                                                                                                                                                   | <pre>[<br> {<br> "volume_size": "100",<br> "volume_type": "gp2"<br> }<br>]</pre> |    no    |
| <a name="input_security_group_ids"></a> [security_group_ids](#input_security_group_ids)                | List of security group ids                                                                                                          | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                        | `[]`                                                                             |    no    |
| <a name="input_subnets"></a> [subnets](#input_subnets)                                                 | List of subnet ids                                                                                                                  | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                        | `[]`                                                                             |    no    |
| <a name="input_tags"></a> [tags](#input_tags)                                                          | Global tags to apply to each ASG. `propagate_at_launch` defaults to true                                                            | <pre>map(object({<br> value = string<br> propagate_at_launch = optional(bool)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                           | `{}`                                                                             |    no    |
| <a name="input_taints"></a> [taints](#input_taints)                                                    | Taints to apply globally to all ASGs.                                                                                               | <pre>map(object({<br> value = string<br> effect = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                | `null`                                                                           |    no    |
| <a name="input_worker_iam_role_name"></a> [worker_iam_role_name](#input_worker_iam_role_name)          | EKS worker iam role name                                                                                                            | `string`                                                                                                                                                                                                                                                                                                                                                                                                                              | `null`                                                                           |    no    |

## Outputs

| Name                                                                    | Description                    |
| ----------------------------------------------------------------------- | ------------------------------ |
| <a name="output_iam_role_arn"></a> [iam_role_arn](#output_iam_role_arn) | ARN of IAM eks autoscaler role |
